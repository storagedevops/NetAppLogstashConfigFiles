input {
  tcp {
    port => 514
    type => syslog
  }
  udp {
    port => 514
    type => syslog
  }
}

filter {
  if [type] == "syslog" {
    grok {
      match => { "message" => "%{SYSLOGTIMESTAMP:syslog_timestamp} \[%{DATA:cluster}-%{DATA:node}:%{DATA:EMS_Indentifier}:%{LOGLEVEL:log-level}]: ?%{GREEDYDATA:syslog_message}" }
      add_field => [ "received_at", "%{@timestamp}" ]
      add_field => [ "received_from", "%{host}" ]
    }
    mutate {
      add_field => {
        "nodename" => "%{cluster}-%{node}"
      }
      remove_field => ["node"]
    }
    dns {
      reverse => [ "host" ]
      action => "replace"
    }
    mutate {
      add_tag => [ "%{log-level}","%{EMS_Indentifier}","%{cluster}" ]
    }
    if [EMS_Indentifier] == "wafl.vvol.renamed" and "RECLAIM" in [syslog_message] and "clone" not in [syslog_message] {
           mutate{
             add_tag => ["Volume_Reclaimed"]
                 }
    }
    if "va2" in [cluster] {
      add_field => {
        "geoLONG" => "-77.329428"
      }
      add_field => {
        "geoLAT" => "38.9488690"
      }
    }
    if [EMS_Indentifier] == "wafl.volume.clone.created" {
           mutate{
             add_tag => ["Clone_Created"]
                 }
    }
    if [EMS_Indentifier] == "wafl.vvol.destroyed" and "clone" in [syslog_message] {
           mutate{
             add_tag => ["Clone_Destroyed"]
                 }
    }
    if [EMS_Indentifier] == "wafl.vvol.renamed" and "clone" in [syslog_message] and "RECLAIM" in [syslog_message] {
           mutate{
             add_tag => ["Clone_Reclaimed"]
                 }
    }
    if [EMS_Indentifier] == "sshd.auth.loginDenied" {
           mutate {
             add_tag => ["failed_login"]
                  }
    }
    if [EMS_Indentifier] == "raid.config.spare.disk.failed" {
           mutate {
             add_tag => ["Spare_Disk_FAILED"]
                  }
    }
    if [EMS_Identifier] == "monitor.globalStatus.nonCritical" and "disk" in [syslog_message] and "failed" in [syslog_message] {
            mutate {
             add_tag => ["RAID_Disk_FAILED"]
            }
    }
    if [EMS_Identifier] == "raid.disk.predictiveFailure" and "prefailed" in [syslog_message] {
            mutate {
             add_tag => ["RAID_Disk_Failing"]
            }
    }
   if [EMS_Indentifier] == "wafl.vol.full" {
           mutate {
             add_tag => ["Volume_Full"]
                  }
    }
    if [log-level] == "debug" and "monitor.volume.nearlyFull" in [EMS_Identifier]{
            mutate {
             add_tag => ["Vol_NearlyFull"]
            }
    }
    if [log-level] == "debug" and "VolNearlyFull" not in [tags]{
            drop {}
    }
    if [EMS_Indentifier] == "rdb.ha.verified" and [log-level] == "notice" {
            drop{}
    }
  }
}


output {
  stdout {
    codec => "rubydebug"
  }
  elasticsearch {
    hosts => "localhost:9200"
    index => "logstash-%{+YYYY.MM.dd}"
  }
}